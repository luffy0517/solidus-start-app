#!/usr/bin/env bash

set -e

case "${DB}" in
  postgres|postgresql)
    railsdb="postgresql"
    host="${DB_POSTGRES_HOST:-${DB_HOST}}"
    username="${DB_USERNAME}"
    password="${DB_PASSWORD}"
    ;;
  mysql)
    railsdb="mysql"
    host="${DB_MYSQL_HOST:-${DB_HOST}}"
    username="${DB_USERNAME}"
    password="${DB_PASSWORD}"
    ;;
  sqlite|'')
    railsdb="sqlite3"
    ;;
  *)
    echo "Invalid DB specified: ${DB}"
    exit 1
    ;;
esac

if [[ -n "${SOLIDUS_BRANCH}" ]]; then
  branch="${SOLIDUS_BRANCH}"
else
  branch="master"
fi

extension_name="solidus_starter_frontend"

if [[ -n "${GENERATE_FRONTEND}" ]]; then
  sandbox_name='sandbox-generated'
  extension_gem_line="gem '${extension_name}', path: '..', require: false"
else
  sandbox_name='sandbox'
  extension_gem_line="gem '${extension_name}', path: '..'"
fi

sandbox_path="./${sandbox_name}"

if [[ -n "${SKIP_SPECS}" ]]; then
  generator_skip_specs_argument='--skip-specs'
  rspec_rails_gem_line=''
else
  generator_skip_specs_argument=''
  rspec_rails_gem_line="gem 'rspec-rails', groups: [:development, :test]"
fi

rm -rf "${sandbox_path}"
bundle exec rails new "${sandbox_name}" --database="${railsdb}" \
  --skip-bundle \
  --skip-git \
  --skip-keeps \
  --skip-rc \
  --skip-spring \
  --skip-test \
  --skip-javascript

if [[ ! -d "${sandbox_name}" ]]; then
  echo 'sandbox rails application failed'
  exit 1
fi

cd "${sandbox_path}"
cat >> Gemfile <<RUBY
# By default, the solidus gem also includes the standard frontend via
# the solidus_frontend gem. To make this extension work, you need to
# exclude it and manually include all the other Solidus components.

solidus_repo = ENV.fetch('SOLIDUS_REPO', 'solidusio/solidus')
solidus_branch = ENV.fetch('SOLIDUS_BRANCH', 'master')
solidus_i18n_repo = ENV.fetch('SOLIDUS_I18N_REPO', 'solidusio/solidus_i18n')
solidus_i18n_branch = ENV.fetch('SOLIDUS_I18N_BRANCH', 'master')

gem 'solidus_core', github: solidus_repo, branch: solidus_branch
gem 'solidus_api', github: solidus_repo, branch: solidus_branch
gem 'solidus_backend', github: solidus_repo, branch: solidus_branch
gem 'solidus_sample', github: solidus_repo, branch: solidus_branch
gem 'solidus_i18n', github: solidus_i18n_repo, branch: solidus_i18n_branch

gem 'rails-i18n'
${extension_gem_line}
gem 'solidus_auth_devise'

${rspec_rails_gem_line}
RUBY

replace_in_database_yml() {
  if [[ "${railsdb}" == "postgresql" ]]; then
    sed -i.bck "/^  adapter:/a \ \ $1:  $2" config/database.yml
  elif [[ "${railsdb}" == "mysql" ]]; then
    sed -i.bck "s/^  $1:.*/\ \ $1: $2/" config/database.yml
  fi

  if [[ -f config/database.yml.bck ]]; then
    rm -f config/database.yml.bck
  fi
}

if [[ -n "${host}" ]]; then
  replace_in_database_yml "host" "${host}"
fi

if [[ -n "${username}" ]]; then
  replace_in_database_yml "username" "${username}"
fi

if [[ -n "${password}" ]]; then
  replace_in_database_yml "password" "${password}"
fi

if [[ -n "${SANDBOX_BUNDLE_PATH}" ]]; then
  bundle config --local path $SANDBOX_BUNDLE_PATH
fi

bundle install --gemfile Gemfile

bundle exec rake db:drop db:create

bundle exec rails generate solidus:install \
  --auto-accept \
  --user_class=Spree::User \
  --enforce_available_locales=true \
  --with-authentication=false \
  --payment-method=none \
  $@

bundle exec rails generate solidus:auth:install --auto-run-migrations

if [[ -z "${GENERATE_FRONTEND}" ]]; then
  if [[ -z "${SKIP_SPECS}" ]]; then
    bundle exec rails g solidus_starter_frontend:rspec
    bundle exec rails g rspec:install
  fi
else
  bundle exec ${extension_name} --auto-accept $generator_skip_specs_argument
fi

echo
echo "ğŸš€ Sandbox app successfully created for $extension_name!"
echo "ğŸš€ Using $railsdb and Solidus $branch"
echo "ğŸš€ Use 'export DB=[postgres|mysql|sqlite]' to control the DB adapter"
echo "ğŸš€ Use 'export SOLIDUS_BRANCH=<BRANCH-NAME>' to control the Solidus version"
echo "ğŸš€ This app is intended for test purposes."
